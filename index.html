<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MegaSantiago | Inicio</title>

    <!-- ✅ CSS (con %20 por el espacio en la carpeta) -->
    <link rel="stylesheet" href="/View/assets/css/estilos.css" />
  <link rel="stylesheet" href="/View/assets/css/overrides.css">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  </head>
  <body>
    <!-- ===== LAYOUT ===== -->
    <div id="header"></div>
    <div id="nav"></div>
    <!-- ================== -->

    <!-- BANNER -->
    <section class="banner-principal">
      <div class="banner-texto">
        <h2>OFERTAS ESPECIALES MEGASANTIAGO</h2>
        <p>Todo para tu oficina y tus clases al mejor precio.</p>
        <button class="btn-primario" onclick="irPromociones()">
          Ver promociones
        </button>
      </div>
    </section>

    <section class="seccion">
      <h2 class="titulo-seccion">Productos más vendidos</h2>
      <div id="gridMasVendidos" class="grid-categorias grid-best-sellers"></div>
    </section>



<section id="promociones" class="seccion">
  <div class="container py-2">
    <h2 class="titulo-seccion mb-3">Ofertas MegaSantiago</h2>
    <div id="gridPromos" class="row g-4 carrusel-productos"></div>
  </div>
</section>



    <!-- ===== FOOTER ===== -->
    <div id="footer"></div>
    <div id="scripts"></div>
    <!-- ================== -->

    <script>
      const API_URL = "/Controller/productosController.php";

      function resolverImagen(img) {
        if (!img || String(img).trim() === "") return "/Model/imagenes/sin-imagen.png";
        const limpia = String(img).trim();
        if (limpia.startsWith("http://") || limpia.startsWith("https://")) return limpia;
        return "/Model/" + limpia;
      }

      function formatearDinero(valor) {
        return "$" + Number(valor).toFixed(2);
      }

      function obtenerCarrito() {
        return JSON.parse(localStorage.getItem("carritoMega") || "[]");
      }

      function guardarCarrito(carrito) {
        localStorage.setItem("carritoMega", JSON.stringify(carrito));
                try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
                if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
        if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
        if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
}

      function agregarAlCarrito(id, nombre, precio) {
        let carrito = obtenerCarrito();
        const existe = carrito.find((p) => p.id === id);

        if (existe) existe.cantidad++;
        else carrito.push({ id, nombre, precio, cantidad: 1 });

        guardarCarrito(carrito);
      }

      function wireBotonesCarrito(selector) {
        document.querySelectorAll(selector).forEach((btn) => {
          btn.addEventListener("click", () => {
            const card = btn.closest("[data-id]");
            if (!card) return;

            agregarAlCarrito(
              card.dataset.id,
              card.dataset.nombre,
              parseFloat(card.dataset.precio)
            );
            alert("Producto agregado al carrito");
          });
        });
      }

      // ✅ Ir a detalle al hacer click en la card (excepto en el botón)
      function wireIrDetalle(selectorCards) {
        document.querySelectorAll(selectorCards).forEach((card) => {
          card.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            const id = card.dataset.id;
            const base = getBasePath();
            window.location.href = `${base}/View/pages/producto.html?id=${encodeURIComponent(id)}`;
          });
        });
      }

      /* ✅ BasePath dinámico (funciona en raíz o subcarpeta) */
      function getBasePath() {
        return window.PROJECT_BASE || "";
      }

      /* ✅ Función real de búsqueda */
      function realizarBusqueda() {
        const input = document.getElementById("buscador");
        if (!input) return;

        const valor = input.value.trim();
        if (!valor) return;

        const base = getBasePath();
        window.location.href = `${base}/View/pages/busqueda.html?q=${encodeURIComponent(valor)}`;
      }

      /* ✅ IMPORTANTÍSIMO: el header llama a realizarBusquedaGlobal() */
      function realizarBusquedaGlobal() {
        realizarBusqueda();
      }

      function irPromociones() {
        const seccion = document.getElementById("promociones");
        if (seccion) seccion.scrollIntoView({ behavior: "smooth" });
      }

      function crearCardMasVendido(prod) {
        const precio = parseFloat(prod.precio);
        const rutaImagen = resolverImagen(prod.imagen);

        return `
          <article class="card-categoria"
                   data-id="${prod.id}"
                   data-nombre="${prod.nombre}"
                   data-precio="${precio}">
              <div class="circulo-img">
                  <img src="${rutaImagen}" alt="${prod.nombre}">
              </div>
              <h3>${prod.nombre}</h3>
              <p class="best-price">${formatearDinero(precio)} + IVA</p>
              <button class="btn-best">Agregar al carrito</button>
          </article>
        `;
      }

function crearCardOferta(prod) {
  const precioBase = parseFloat(prod.precio);
  const precioOferta = prod.precio_oferta ? parseFloat(prod.precio_oferta) : null;

  // Si no hay oferta, no mostramos el producto en esta sección
  if (!precioOferta || !(precioOferta > 0) || !(precioOferta < precioBase)) return "";

  const descuento = Math.round((1 - precioOferta / precioBase) * 100);
  const ahorro = (precioBase - precioOferta).toFixed(2);
  const rutaImagen = resolverImagen(prod.imagen);

  return `
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden position-relative"
           data-id="${prod.id}"
           data-nombre="${prod.nombre}"
           data-precio="${precioOferta}"
           style="cursor:pointer;">

        <!-- Badge descuento -->
        <span class="badge bg-danger position-absolute top-0 start-0 m-3 px-3 py-2 rounded-pill">
          -${descuento}%
        </span>

        <!-- Imagen -->
        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
          <img src="${rutaImagen}" alt="${prod.nombre}"
               class="img-fluid p-3" style="max-height: 170px; object-fit: contain;">
        </div>

        <!-- Body -->
        <div class="card-body d-flex flex-column">
          <h6 class="fw-semibold mb-2" style="min-height: 40px;">
            ${prod.nombre}
          </h6>

          <div class="mb-2">
            <span class="text-muted text-decoration-line-through me-2">
              ${formatearDinero(precioBase)}
            </span>
            <span class="fs-5 fw-bold text-danger">
              ${formatearDinero(precioOferta)}
            </span>
          </div>

          <small class="text-success mb-3">
            Ahorras ${formatearDinero(ahorro)}
          </small>

          <div class="mt-auto d-flex justify-content-end">
            <button class="btn btn-warning rounded-circle fw-bold btn-add"
                    style="width:44px;height:44px;">
              +
            </button>
          </div>
        </div>

      </div>
    </div>
  `;
}




      async function cargarMasVendidos() {
        const cont = document.getElementById("gridMasVendidos");
        if (!cont) return;
        cont.innerHTML = "<p>Cargando productos...</p>";

        try {
          const resp = await fetch(`${API_URL}?accion=masVendidos&limit=4`);
          const data = await resp.json();

          if (!Array.isArray(data) || data.length === 0) {
            cont.innerHTML = "<p>No hay productos para mostrar.</p>";
            return;
          }

          cont.innerHTML = data.map(crearCardMasVendido).join("");
          wireBotonesCarrito("#gridMasVendidos .btn-best");

          // ✅ FIX: en más vendidos las cards son .card-categoria (no .card-producto)
          wireIrDetalle("#gridMasVendidos .card-categoria");
        } catch (err) {
          console.error(err);
          cont.innerHTML = "<p>Error al cargar los productos.</p>";
        }
      }

      async function cargarOfertas() {
        const cont = document.getElementById("gridOfertas");
        if (!cont) return;
        cont.innerHTML = "<p>Cargando ofertas...</p>";

        try {
          const resp = await fetch(`${API_URL}?accion=ofertas&limit=6`);
          const data = await resp.json();

          if (!Array.isArray(data) || data.length === 0) {
            cont.innerHTML = "<p>No hay ofertas disponibles.</p>";
            return;
          }

          cont.innerHTML = data.map(crearCardOferta).join("");
          wireBotonesCarrito("#gridOfertas .btn-add");
          wireIrDetalle("#gridOfertas .card-producto");
        } catch (err) {
          console.error(err);
          cont.innerHTML = "<p>Error al cargar las ofertas.</p>";
        }
      }

      async function cargarPromociones() {
  const cont = document.getElementById("gridPromos");
  if (!cont) return;

  try {
    const resp = await fetch(`${API_URL}?accion=ofertas&limit=8`);
    const data = await resp.json();

    if (!Array.isArray(data) || data.length === 0) {
      cont.innerHTML = "<p>No hay ofertas disponibles.</p>";
      return;
    }

    cont.innerHTML = data.map(crearCardOferta).join("");
    wireBotonesCarrito("#gridPromos .btn-add");
wireIrDetalle("#gridPromos [data-id]");

  } catch (err) {
    console.error(err);
    cont.innerHTML = "<p>Error al cargar las ofertas.</p>";
  }
}


      function initIndexPage() {
  const buscador = document.getElementById("buscador");
  if (buscador) {
    buscador.addEventListener("keyup", (e) => {
      if (e.key === "Enter") realizarBusqueda();
    });
  }

  cargarMasVendidos();
  cargarPromociones(); // esta será tu ÚNICA sección de ofertas
}

    </script>

    <!-- LAYOUT -->
    <script src="/View/assets/js/layout-loader.js"></script>

    <script>
      loadLayout().then(() => {
        initIndexPage();

        // ✅ Cargar sesión usuario DESPUÉS del layout
        const s = document.createElement("script");
        s.src = "View/assets/js/sesion-usuario.js";
        document.body.appendChild(s);
      });
    </script>
  </body>
</html>
